name: Deploy to Kubernetes

on:
  push:
    branches: [ main ]
  workflow_run:
    workflows: ["Build and Push Backend Image", "Build and Push Frontend Image", "Build and Push Event Processor Image"]
    types: [completed]
    branches: [ main ]

env:
  KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.10.0'

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.26.0'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Run Helm dependency update
        run: |
          cd charts/todo-chatbot
          helm dependency update

      - name: Run Helm lint
        run: |
          cd charts/todo-chatbot
          helm lint .

      - name: Deploy to Kubernetes
        run: |
          cd charts/todo-chatbot
          helm upgrade --install todo-chatbot . \
            --namespace todo-chatbot \
            --create-namespace \
            --set backend.image.tag=${{ github.sha }} \
            --set frontend.image.tag=${{ github.sha }} \
            --set eventProcessor.image.tag=${{ github.sha }} \
            --timeout 10m

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/{{ include "todo-chatbot.fullname" . }}-backend --namespace todo-chatbot --timeout=5m
          kubectl rollout status deployment/{{ include "todo-chatbot.fullname" . }}-frontend --namespace todo-chatbot --timeout=5m
          kubectl rollout status deployment/{{ include "todo-chatbot.fullname" . }}-event-processor --namespace todo-chatbot --timeout=5m

      - name: Run post-deployment tests
        run: |
          # Add any post-deployment tests here
          echo "Running post-deployment tests..."

          # Check if all pods are running
          kubectl get pods -n todo-chatbot

          # Run health checks
          sleep 30
          kubectl get services -n todo-chatbot

      - name: Slack Notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          fields: workflow,job,ref,author,took
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}